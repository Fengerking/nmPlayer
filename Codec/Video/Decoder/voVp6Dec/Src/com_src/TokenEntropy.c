/****************************************************************************
*
*   Module Title :     TokenEntropy.c
*
*   Description  :     Entropy configuration routines.
*
****************************************************************************/

/****************************************************************************
*  Header Files
****************************************************************************/
#include "tokenentropy.h"
#include "pbdll.h"

/****************************************************************************
*   Exports
****************************************************************************/
const UINT8 VP6_DcUpdateProbs[2][MAX_ENTROPY_TOKENS-1] = 
{ 
	{ 146, 255, 181, 207, 232, 243, 238, 251, 244, 250, 249 },
	{ 179, 255, 214, 240, 250, 255, 244, 255, 255, 255, 255 }
};

const UINT8 ScanBandUpdateProbs[BLOCK_SIZE] = 
{  
	255, 132, 132, 159, 153, 151, 161, 170, 
	164, 162, 136, 110, 103, 114, 129, 118, 
	124, 125, 132, 136, 114, 110, 142, 135, 
	134, 123, 143, 126, 153, 183, 166, 161, 
	171, 180, 179, 164, 203, 218, 225, 217, 
	215, 206, 203, 217, 229, 241, 248, 243,
	253, 255, 253, 255, 255, 255, 255, 255, 
	255, 255, 255, 255, 255, 255, 255, 255 
};

const UINT8 ZrlUpdateProbs[ZRL_BANDS][ZERO_RUN_PROB_CASES] =
{
	{ 219, 246, 238, 249, 232, 239, 249, 255, 248, 253, 239, 244, 241, 248 }, 
	{ 198, 232, 251, 253, 219, 241, 253, 255, 248, 249, 244, 238, 251, 255 }, 
};

// Zero run probs 
const UINT8 ZeroRunProbDefaults[ZRL_BANDS][ZERO_RUN_PROB_CASES] = 
{  
	{ 198, 197, 196, 146, 198, 204, 169, 142, 130, 136, 149, 149, 191, 249 },
	{ 135, 201, 181, 154,  98, 117, 132, 126, 146, 169, 184, 240, 246, 254 },
};

const UINT8 VP6_AcUpdateProbs[PREC_CASES][2][VP6_AC_BANDS][MAX_ENTROPY_TOKENS-1] =
{
	{	// preceded by 0
		{
			{ 227, 246, 230, 247, 244, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 209, 231, 231, 249, 249, 253, 255, 255, 255 },
			{ 255, 255, 225, 242, 241, 251, 253, 255, 255, 255, 255 },
			{ 255, 255, 241, 253, 252, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 248, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
		},
		{
			{ 240, 255, 248, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 240, 253, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
		},
	},
	{	// preceded by 1
		{
			{ 206, 203, 227, 239, 247, 255, 253, 255, 255, 255, 255 },
			{ 207, 199, 220, 236, 243, 252, 252, 255, 255, 255, 255 },
			{ 212, 219, 230, 243, 244, 253, 252, 255, 255, 255, 255 },
			{ 236, 237, 247, 252, 253, 255, 255, 255, 255, 255, 255 },
			{ 240, 240, 248, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
		},
		{
			{ 230, 233, 249, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 238, 238, 250, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 248, 251, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
		},
	},
	{	// preceded by > 1
		{
			{ 225, 239, 227, 231, 244, 253, 243, 255, 255, 253, 255 },
			{ 232, 234, 224, 228, 242, 249, 242, 252, 251, 251, 255 },
			{ 235, 249, 238, 240, 251, 255, 249, 255, 253, 253, 255 },
			{ 249, 253, 251, 250, 255, 255, 255, 255, 255, 255, 255 },
			{ 251, 250, 249, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
		},
		{
			{ 243, 244, 250, 250, 255, 255, 255, 255, 255, 255, 255 },
			{ 249, 248, 250, 253, 255, 255, 255, 255, 255, 255, 255 },
			{ 253, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
			{ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 },
		},
	},
};

/****************************************************************************
*   Module Statics
****************************************************************************/
// Dc context equations: Dc Token contexts are 00 0!0 and !0!0
static const LINE_EQ VP6_DcNodeEqs[CONTEXT_NODES][DC_TOKEN_CONTEXTS] =
{
	{ { 122, 133 },{ 133,  51 },{ 142, -16 } },		// Zero Node	
	{ {   0,   1 },{   0,   1 },{   0,   1 } },		// EOB Node		Dummy as no EOBs in DC
	{ {  78, 171 },{ 169,  71 },{ 221, -30 } },		// One Node
	{ { 139, 117 },{ 214,  44 },{ 246,  -3 } },		// Low Val Node
	{ { 168,  79 },{ 210,  38 },{ 203,  17 } },		// Two Node (2 vs 3 or 4)
};

/****************************************************************************
 * 
 *  ROUTINE       :     VP6_ConfigureContexts
 *
 *  INPUTS        :     PB_INSTANCE *pbi : Pointer to decoder instance.
 *                      
 *  OUTPUTS       :     None.
 *
 *  RETURNS       :     void
 *
 *  FUNCTION      :     Configures the context dependant entropy probabilities.
 *
 *  SPECIAL NOTES :     None. 
 *
 ****************************************************************************/
void VP6_ConfigureContexts ( PB_INSTANCE *pbi )
{
	UINT32 i;
	UINT32 Node;
	UINT32 Plane;
	INT32  Temp;

	// Clear MMX state so floating point can work again

	// DC Node Probabilities
	for ( Plane=0; Plane<2; Plane++ )
	{
		for ( i=0; i<DC_TOKEN_CONTEXTS; i++ )
		{
			// Tree Nodes
			for ( Node=0; Node<CONTEXT_NODES; Node++ )
			{
				Temp = ( ( pbi->DcProbs[DCProbOffset(Plane,Node)] * VP6_DcNodeEqs[Node][i].M + 128 ) >> 8) 
    					+ VP6_DcNodeEqs[Node][i].C;	
				Temp = (Temp > 255)? 255: Temp;
				Temp = (Temp <   1)? 1  : Temp;
				
				//pbi->DcNodeContexts[Plane][i][Node] = (UINT8)Temp;
				*(pbi->DcNodeContexts + DcNodeOffset(Plane,i,Node)) = (UINT8)Temp;
			}
		}
	}
}
